FROM nvcr.io/nvidia/cuda:12.6.1-runtime-ubuntu22.04@sha256:aa0da342b530a7dd2630b17721ee907fc9210b4e159d67392c4c373bef642483

# Install system dependencies
RUN apt-get update \
    && DEBIAN_FRONTEND="noninteractive" apt-get install -y --no-install-recommends --allow-change-held-packages \
        build-essential \
        cmake \
        git \
        libgtk-3-dev \
        libpython3.10 \
        libxkbcommon-x11-0 \
        python3-pip \
        python3-dev \
        unzip \
        vulkan-tools \
        wget \
        pkg-config \
        libusb-1.0-0-dev \
        libssl-dev \
        libglfw3-dev \
        libgl1-mesa-dev \
        libglu1-mesa-dev \
        libatlas-base-dev \
        libsuitesparse-dev \
        libeigen3-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip3 install --upgrade pip

# Clone and build librealsense following the README instructions
RUN git clone https://github.com/IntelRealSense/librealsense.git /opt/librealsense \
    && cd /opt/librealsense \
    && mkdir build && cd build \
    && cmake ../ \
        -DCMAKE_BUILD_TYPE=Release \
        -DFORCE_RSUSB_BACKEND=ON \
        -DBUILD_EXAMPLES=true \
        -DBUILD_PYTHON_BINDINGS=true \
        -DPYTHON_EXECUTABLE=$(which python3) \
    && make -j$(nproc) \
    && make install

# Copy udev rules for RealSense cameras
RUN mkdir -p /etc/udev/rules.d/ && cp /opt/librealsense/config/99-realsense-libusb.rules /etc/udev/rules.d/

# Set Python path for pyrealsense2 (following README instructions)
ENV PYTHONPATH=/opt/librealsense/build/Release

# Set working directory
WORKDIR /pycuvslam

# Install Python dependencies for pycuvslam
COPY examples/requirements.txt /tmp/requirements.txt
RUN pip3 install -r /tmp/requirements.txt

# Install additional GUI dependencies for rerun-sdk
RUN apt-get update \
    && DEBIAN_FRONTEND="noninteractive" apt-get install -y --no-install-recommends \
        libx11-6 \
        libxext6 \
        libxrender1 \
        libxtst6 \
        libxi6 \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxrandr2 \
        libxss1 \
        libxcb1 \
        libxcomposite1 \
        libxcursor1 \
        libxdamage1 \
        libxfixes3 \
        libxinerama1 \
        libxrandr2 \
        libxrender1 \
        libxtst6 \
        libnss3 \
        libcups2 \
        libdbus-1-3 \
        libatk1.0-0 \
        libgtk-3-0 \
        libgdk-pixbuf2.0-0 \
        libpangocairo-1.0-0 \
        libcairo2 \
        libpango-1.0-0 \
        libatspi2.0-0 \
        libdrm2 \
        libgbm1 \
        libasound2 \
        mesa-vulkan-drivers \
        vulkan-tools \
        udev \
        python3-dev \ 
        python3-venv \ 
        python3-pip \
        python3-opencv \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Test that pyrealsense2 can be imported
RUN python3 -c "import pyrealsense2 as rs; print('pyrealsense2 imported successfully')"

# Test that rerun-sdk can be imported
RUN python3 -c "import rerun as rr; print('rerun-sdk imported successfully')"

# Add orbbec camera support
RUN git clone https://github.com/orbbec/OrbbecSDK.git /opt/OrbbecSDK \
    && cd /opt/OrbbecSDK \
    && git checkout eb518e51e71b8646756137ed81c97cefdef4550d \
    && mkdir build && cd build \
    && cmake .. \
    && make -j$(nproc) \
    && make install

RUN cd /opt/OrbbecSDK/misc/scripts \
    && chmod +x ./install_udev_rules.sh \
    && ./install_udev_rules.sh

RUN git clone https://github.com/orbbec/pyorbbecsdk.git /opt/pyorbbecsdk \
    && cd /opt/pyorbbecsdk \
    && git checkout ee32b475fdd3a433c568842597c55d29b385052e \
    && pip3 install -r requirements.txt \
    && mkdir build && cd build \
    && cmake -Dpybind11_DIR=`pybind11-config --cmakedir` .. \
    && make -j$(nproc) \
    && make install \
    && cd .. \
    && pip3 install wheel \
    && python3 setup.py bdist_wheel \
    && pip3 install dist/*.whl

# Startup commands are now handled directly in run_docker_x86.sh 
